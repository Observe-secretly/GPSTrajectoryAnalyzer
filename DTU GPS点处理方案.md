# 📍 DTU 设备 GPS 定位数据处理方案（最终版）

## 🧭 一、系统目标

从 DTU 设备连续上报的 GPS 点中：

* **剔除漂移点**，提升轨迹数据质量；
* **动态计算基准点**，实现稳定追踪；
* **定时压缩轨迹上报**，降低带宽占用；
* **识别并容忍高速直线运动轨迹**，防止误判漂移。

---

## 📦 二、数据输入说明

* **采样频率**：每秒 1 个 GPS 点（经纬度）；
* **上报周期**：每 3 分钟上报一次，最多 180 个点；
* **每次上报限制**：最多上报 6 个代表点。

---

## 🔍 三、基准点与漂移点判定逻辑

### 1. 滑动窗口管理

* 维护一个**滑动窗口**保存最近的有效点；
* **窗口大小：10 个点**；
* 只有当窗口满 10 个点后才计算基准点。

---

### 2. 基准点计算方式

* 从窗口中的 10 个点中计算：

  * **中位点**（或质心，推荐中位点）作为**基准点**；
  * 所有点到基准点的**最大距离**，称为“半径”；
* 定义：`动态漂移阈值 = 半径 × 2`；
* 设定上限：如最大不超过 100 米。

---

### 3. 漂移点判断

* 对每秒新采集的点 P，计算其与基准点的距离 D；
* 若 D ≤ 动态漂移阈值：

  * P 判定为**有效点**；
  * 加入滑动窗口；
  * 清空漂移点队列；
  * 刷新基准点有效期；
* 若 D > 动态漂移阈值：

  * P 判定为**漂移点**；
  * 加入漂移点队列。

---

### 4. 连续漂移点修正机制（**防止高速直线运动误判**）

#### 当漂移点队列中点数 ≥ 3 时

* 从队尾取最近的 3 个点：P1、P2、P3；
* 计算这三个点组成三角形的三个角度，提取最小角度；
* **判断逻辑**：

  * 若**最小角度 ≤ 30°** 且 `P1 → P3 距离 ≤ 动态漂移阈值 × 5`：

    * 判定为“直线加速中的真实轨迹”；
    * 将这 3 个点**恢复为有效点**，加入滑动窗口；
    * 清空漂移队列；
    * 更新基准点和动态漂移阈值；
  * 否则：

    * 保持这 3 个点在漂移队列中；
    * 等待新的点进入，继续滚动检查最新的 3 个点。

---

### 5. 基准点失效判定与重建

* 若**漂移点队列长度达到 10**，且未被修正为直线轨迹：

  * 判定当前基准点**失效**；
  * 使用这 10 个漂移点重新计算新的：

    * 基准点；
    * 动态漂移阈值；
  * 清空原滑动窗口；
  * 将漂移点作为新的滑窗基础。

---

## ☁️ 四、上报逻辑（每 3 分钟压缩）

### 数据输入

* 3 分钟内累计到的所有有效点（最多约 180 个）。

### 压缩方案（推荐方案 1）

* 将有效点按时间顺序平均划分为 **6 段**；
* 每段内计算点的**质心**（经纬度平均）；
* 每段输出 1 个代表点，共 6 个点上报；
* 避免因起始点偏移造成轨迹失真。

---

## ⚙️ 五、关键参数建议

| 参数        | 默认值             | 说明            |
| --------- | --------------- | ------------- |
| 滑动窗口大小    | 10 点            | 用于计算基准点       |
| 基准点有效期    | 30 秒            | 可选，用于防止长时间无更新 |
| 动态漂移阈值    | 半径 × 2，最大 100 米 | 判定漂移点依据       |
| 最小角度判断阈值  | 30°             | 判断是否为直线运动轨迹   |
| 最大直线段距离   | 动态阈值 × 5        | 限制跳点拉直风险      |
| 漂移点队列长度上限 | 10              | 超过则触发基准点重建    |
| 上报周期      | 3 分钟            | 每次最多压缩为 6 个点  |

---

## 🧠 六、整套方案特点总结

| 模块             | 说明                  |
| -------------- | ------------------- |
| ✅ 动态漂移阈值       | 随环境变化适配，解决静止与快速移动问题 |
| ✅ 中位点/质心判断基准点  | 抗异常能力强，稳定性高         |
| ✅ 高速直线识别机制     | 解决连续漂移误判问题          |
| ✅ 自动基准点更新与恢复机制 | 具备鲁棒性与自修复能力         |
| ✅ 上报压缩策略合理     | 减少数据量，保持轨迹代表性       |

---

## 🧭 七、整体流程简图（文字版）

```text
[每秒采集 GPS 点]
       ↓
[是否满足滑动窗口要求？]
       ↓
[计算基准点 + 动态半径]
       ↓
[判断当前点是否漂移]
       ↓
  ┌───────────────┐
  ↓               ↓
有效点       →  漂移点（加入漂移队列）
  ↓               ↓
加入滑窗     若漂移点 ≥ 3：
更新基准点      → 判断是否直线运动
清空漂移队列    → 若是，恢复为有效点
               → 否则，继续等待
       ↓
漂移点累计达 10 → 重算基准点
       ↓
每 3 分钟触发上报 → 有效点划分为 6 段 → 每段取质心 → 上报
```

---

## 🚀 八、系统实现与功能更新记录

### 8.1 核心功能实现

#### GPS数据处理核心算法

* **文件位置**: `src/utils/gpsProcessor.ts`

* **主要功能**: 实现了完整的GPS轨迹处理算法，包括漂移检测、基准点计算、直线运动识别等
* **关键方法**:
  * `processTrajectory()`: 主要轨迹处理入口
  * `isLinearMotion()`: 直线运动检测
  * `updateBasePoint()`: 基准点更新
  * `calculateBasePointRadius()`: 动态半径计算

#### 可视化界面

* **文件位置**: `src/views/HomeView.vue`

* **功能**: 基于高德地图的GPS轨迹可视化展示
* **特性**: 支持原始轨迹、处理后轨迹对比显示

### 8.2 模拟数据生成系统

#### 模拟场景设计

为了全面测试GPS处理算法，实现了多种模拟场景：

1. **静态漂移场景**
   * 在轨迹中随机选择基准点
   * 在基准点周围生成多个漂移点
   * 漂移距离分布：90%在10-50米范围，10%在50-200米范围

2. **运动漂移场景**
   * 模拟连续运动中的GPS漂移
   * 生成连续的漂移点序列
   * 同样采用90%/10%的距离分布规则

3. **高速场景**
   * 识别轨迹中的直线段
   * 删除部分点模拟高速运动时的数据缺失
   * 实现距离过滤机制，确保高速标记分布均匀

4. **重建场景**
   * 模拟基准点失效后的重建过程
   * 在轨迹末尾添加重建标记

### 8.3 标记点图例系统

#### 交互式图例功能

* **位置**: `HomeView.vue` 右侧面板

* **功能**: 点击切换不同类型标记的显示/隐藏
* **支持的标记类型**:
  * 🔴 隧道标记 (tunnel)
  * 🟡 漂移标记 (drift)
  * 🟢 高速标记 (highway)
  * 🔵 重建标记 (rebuild)

#### 实时统计显示

* 显示每种标记的数量

* 显示当前显示状态（显示/隐藏）
* 响应式更新，支持实时切换

### 8.4 关键技术优化

#### 高速场景标记位置修复

* **问题**: 高速标记集中在轨迹起点附近

* **原因**: 在数据处理开始时记录标记位置，后续插入的漂移点改变了原始索引
* **解决方案**: 将高速场景的查找和标记生成移到所有数据修改之后
* **效果**: 高速标记现在均匀分布在轨迹上

#### 距离过滤机制

* **实现**: 在高速场景选择中加入最小距离检查

* **规则**: 两个高速点之间距离必须大于1000米（5倍最大漂移距离）
* **效果**: 避免高速标记过于集中，提升可视化效果

#### 漂移距离分布优化

* **策略**: 采用概率分布控制漂移距离

* **分布规则**:
  * 90%的漂移点：10-50米范围
  * 10%的漂移点：50-200米范围
* **优势**: 更贴近真实GPS设备的误差特征

### 8.5 代码质量改进

#### 类型安全

* 修复了静态方法中错误调用实例方法的问题

* 添加了`calculateDistance`静态方法用于距离计算
* 完善了TypeScript类型定义

#### 代码结构

* 将复杂的数据处理逻辑模块化

* 分离了模拟数据生成和真实数据处理逻辑
* 优化了计算属性的响应式设计

#### 性能优化

* 实现了标记数据的按需过滤

* 优化了地图标记的渲染性能
* 减少了不必要的计算和重渲染

### 8.6 用户体验提升

#### 可视化增强

* 不同类型标记使用不同颜色和图标

* 支持标记的交互式显示/隐藏
* 实时显示标记数量和状态

#### 操作便捷性

* 一键切换标记显示状态

* 直观的图例界面设计
* 响应式布局适配不同屏幕尺寸

---

## 📈 九、测试与验证

### 9.1 模拟数据测试

* ✅ 静态漂移场景测试通过

* ✅ 运动漂移场景测试通过  
* ✅ 高速场景生成测试通过
* ✅ 标记点分布均匀性验证通过

### 9.2 功能完整性测试

* ✅ GPS轨迹处理算法功能完整

* ✅ 可视化展示功能正常
* ✅ 标记点图例交互功能正常
* ✅ 模拟数据生成功能稳定

### 9.3 代码质量验证

* ✅ 无TypeScript编译错误

* ✅ 无ESLint代码规范问题
* ✅ 核心功能单元测试覆盖
* ✅ 性能表现良好
