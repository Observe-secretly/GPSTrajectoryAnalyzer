# 📍 GPS轨迹分析系统设计方案

## 🧭 一、系统目标

从连续上报的 GPS 点中：

* **剔除漂移点**，提升轨迹数据质量；
* **动态计算基准点**，实现稳定追踪；
* **定时压缩轨迹上报**，降低带宽占用；
* **识别并容忍高速直线运动轨迹**，防止误判漂移。

---

## 📦 二、数据输入说明

* **采样频率**：每秒 1 个 GPS 点（经纬度）；
* **上报周期**：每 3 分钟上报一次，最多 180 个点；
* **每次上报限制**：最多上报 6 个代表点。

---

## 🔍 三、基准点与漂移点判定逻辑

### 1. 滑动窗口管理

* 维护一个**滑动窗口**保存最近的有效点；
* **窗口大小：10 个点**；
* 只有当窗口满 10 个点后才计算基准点。

---

### 2. 基准点计算方式

* 从窗口中的 10 个点中计算：

  * **中位点**（或质心，推荐中位点）作为**基准点**；
  * 所有点到基准点的**最大距离**，称为"半径"；
* 定义：`动态漂移阈值 = 半径 × 2`；
* 设定上限：如最大不超过 100 米。

---

### 3. 漂移点判断

* 对每秒新采集的点 P，计算其与基准点的距离 D；
* 若 D ≤ 动态漂移阈值：

  * P 判定为**有效点**；
  * 加入滑动窗口；
  * 清空漂移点队列；
  * 刷新基准点有效期；
* 若 D > 动态漂移阈值：

  * P 判定为**漂移点**；
  * 加入漂移点队列。

---

### 4. 连续漂移点修正机制（**防止高速直线运动误判**）

#### 当漂移点队列中点数 ≥ 3 时

* 从队尾取最近的 3 个点：P1、P2、P3；
* 计算这三个点组成三角形的三个角度，提取最小角度；
* **判断逻辑**：

  * 若**最小角度 ≤ 30°** 且 `P1 → P3 距离 ≤ 动态漂移阈值 × 5`：

    * 判定为"直线加速中的真实轨迹"；
    * 将这 3 个点**恢复为有效点**，加入滑动窗口；
    * 清空漂移队列；
    * 更新基准点和动态漂移阈值；
  * 否则：

    * 保持这 3 个点在漂移队列中；
    * 等待新的点进入，继续滚动检查最新的 3 个点。

---

### 5. 基准点失效判定与重建

* 若**漂移点队列长度达到 10**，且未被修正为直线轨迹：

  * 判定当前基准点**失效**；
  * 使用这 10 个漂移点重新计算新的：

    * 基准点；
    * 动态漂移阈值；
  * 清空原滑动窗口；
  * 将漂移点作为新的滑窗基础。

---

## ☁️ 四、上报逻辑（每 3 分钟压缩）

### 数据输入

* 3 分钟内累计到的所有有效点（最多约 180 个）。

### 压缩方案（推荐方案 1）

* 将有效点按时间顺序平均划分为 **6 段**；
* 每段内计算点的**质心**（经纬度平均）；
* 每段输出 1 个代表点，共 6 个点上报；
* 避免因起始点偏移造成轨迹失真。

---

## ⚙️ 五、关键参数建议

| 参数        | 默认值             | 说明            |
| --------- | --------------- | ------------- |
| 滑动窗口大小    | 10 点            | 用于计算基准点       |
| 基准点有效期    | 30 秒            | 可选，用于防止长时间无更新 |
| 动态漂移阈值    | 半径 × 2，最大 100 米 | 判定漂移点依据       |
| 最小角度判断阈值  | 30°             | 判断是否为直线运动轨迹   |
| 最大直线段距离   | 动态阈值 × 5        | 限制跳点拉直风险      |
| 漂移点队列长度上限 | 10              | 超过则触发基准点重建    |
| 上报周期      | 3 分钟            | 每次最多压缩为 6 个点  |

---

## 🧠 六、整套方案特点总结

| 模块             | 说明                  |
| -------------- | ------------------- |
| ✅ 动态漂移阈值       | 随环境变化适配，解决静止与快速移动问题 |
| ✅ 中位点/质心判断基准点  | 抗异常能力强，稳定性高         |
| ✅ 高速直线识别机制     | 解决连续漂移误判问题          |
| ✅ 自动基准点更新与恢复机制 | 具备鲁棒性与自修复能力         |
| ✅ 上报压缩策略合理     | 减少数据量，保持轨迹代表性       |

---

## 🧭 七、整体流程简图（文字版）

```text
[每秒采集 GPS 点]
       ↓
[是否满足滑动窗口要求？]
       ↓
[计算基准点 + 动态半径]
       ↓
[判断当前点是否漂移]
       ↓
  ┌───────────────┐
  ↓               ↓
有效点       →  漂移点（加入漂移队列）
  ↓               ↓
加入滑窗     若漂移点 ≥ 3：
更新基准点      → 判断是否直线运动
清空漂移队列    → 若是，恢复为有效点
               → 否则，继续等待
       ↓
漂移点累计达 10 → 重算基准点
       ↓
每 3 分钟触发上报 → 有效点划分为 6 段 → 每段取质心 → 上报
```

---

## 🚀 八、系统实现与功能更新记录

### 8.1 核心功能实现

#### GPS数据处理核心算法

* **文件位置**: `src/utils/gpsProcessor.ts`

* **主要功能**: 实现了完整的GPS轨迹处理算法，包括漂移检测、基准点计算、直线运动识别等
* **关键方法**:
  * `processTrajectory()`: 主要轨迹处理入口
  * `isLinearMotion()`: 直线运动检测
  * `updateBasePoint()`: 基准点更新
  * `calculateBasePointRadius()`: 动态半径计算

#### 可视化界面

* **文件位置**: `src/views/HomeView.vue`

* **功能**: 基于高德地图的GPS轨迹可视化展示
* **特性**: 支持原始轨迹、处理后轨迹对比显示

### 8.2 模拟数据生成系统

#### 模拟场景设计

为了全面测试GPS处理算法，实现了多种模拟场景：

1. **静态漂移场景**
   * 在轨迹中随机选择基准点
   * 在基准点周围生成多个漂移点
   * 漂移距离分布：90%在10-50米范围，10%在50-200米范围

2. **运动漂移场景**
   * 模拟连续运动中的GPS漂移
   * 生成连续的漂移点序列
   * 同样采用90%/10%的距离分布规则

3. **高速场景**
   * 识别轨迹中的直线段
   * 模拟高速行驶时的GPS采样间隔
   * 删除部分点以模拟高速状态

4. **隧道场景**
   * 在轨迹中随机选择位置
   * 删除连续的GPS点
   * 模拟隧道内信号丢失

### 8.3 算法优化记录

1. **漂移检测优化**
   * 引入动态阈值计算
   * 考虑历史点的分布特征
   * 优化边界条件处理

2. **直线运动识别改进**
   * 增加角度计算精度
   * 优化距离阈值判断
   * 改进连续点判断逻辑

3. **基准点计算优化**
   * 改进中位点计算方法
   * 增加异常值过滤
   * 优化重建时机判断

### 8.4 性能优化

1. **计算效率提升**
   * 优化距离计算方法
   * 减少重复计算
   * 使用缓存机制

2. **内存占用优化**
   * 优化数据结构
   * 及时清理无用数据
   * 控制缓存大小

### 8.5 代码质量改进

#### 类型安全

* 完善 TypeScript 类型定义
* 修复了静态方法中错误调用实例方法的问题
* 添加了`calculateDistance`静态方法用于距离计算

#### 代码结构

* 将复杂的数据处理逻辑模块化
* 分离了模拟数据生成和真实数据处理逻辑
* 优化了计算属性的响应式设计

---

## 📈 九、测试与验证

### 9.1 功能测试

* ✅ 基本轨迹处理
* ✅ 漂移点检测
* ✅ 直线运动识别
* ✅ 基准点动态更新
* ✅ 数据压缩上报

### 9.2 性能测试

* ✅ 大数据量处理
* ✅ 实时处理响应
* ✅ 内存占用合理
* ✅ CPU使用率正常

### 9.3 代码质量验证

* ✅ 无TypeScript编译错误
* ✅ 无ESLint代码规范问题
* ✅ 核心功能单元测试覆盖
* ✅ 性能表现良好
